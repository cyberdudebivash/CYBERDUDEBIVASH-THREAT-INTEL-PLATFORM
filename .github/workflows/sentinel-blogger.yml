name: publish-threat-report

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:      # Manual trigger enabled

permissions:
  contents: write         # REQUIRED: Allows the bot to push manifest updates
  pages: write
  id-token: write

jobs:
  triage-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Essential for pushing back to same repo

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Forensic Dependencies
        run: |
          pip install feedparser google-api-python-client google-auth-oauthlib google-auth-httplib2

      - name: Ensure GOC Directories Exist
        run: mkdir -p data/stix

      - name: Run Sentinel APEX v10.1 Engine
        env:
          BLOG_ID: ${{ secrets.BLOG_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: python -m agent.sentinel_blogger

      - name: Commit & Push GOC Manifest
        run: |
          git config --global user.name "CDB-Apex-Bot"
          git config --global user.email "bot@cyberdudebivash.com"
          git add data/stix/*.json
          git commit -m "v10.1 Apex: Intelligence manifest synchronization [skip ci]" || echo "No changes to sync"
          git push origin main # Pushes back to main to refresh the Dashboard

"""
Malware Intelligence Feed Ingestion
FINAL • PRODUCTION • INTERFACE-HARDENED

Provides a stable malware activity interface for the platform.
Gracefully handles feed outages and naming variations.
"""

from typing import List, Dict
import requests


# =================================================
# CONFIGURATION
# =================================================

# Example: MalwareBazaar public API (may rate-limit or go offline)
MALWAREBAZAAR_URL = "https://mb-api.abuse.ch/api/v1/"


# =================================================
# INTERNAL FETCHER
# =================================================

def _fetch_malware_data() -> List[Dict]:
    """
    Internal malware feed fetcher.

    NOTE:
    Malware feeds are often unstable or rate-limited.
    Failures MUST NOT break the pipeline.
    """

    payload = {
        "query": "get_recent",
        "selector": "time"
    }

    response = requests.post(
        MALWAREBAZAAR_URL,
        data=payload,
        timeout=30,
    )
    response.raise_for_status()

    data = response.json()

    if data.get("query_status") != "ok":
        return []

    results = []
    for item in data.get("data", []):
        results.append({
            "family": item.get("signature"),
            "severity": "HIGH",
            "sha256": item.get("sha256_hash"),
            "first_seen": item.get("first_seen"),
        })

    return results


# =================================================
# PRIMARY PUBLIC API (MANDATORY)
# =================================================

def fetch_malware_activity() -> List[Dict]:
    """
    Fetch recent malware activity.

    This is the PRIMARY function expected by orchestrators.
    It MUST remain stable.
    """
    try:
        return _fetch_malware_data()
    except Exception as exc:
        print(f"⚠️ Malware feed unavailable: {exc}")
        return []


# =================================================
# BACKWARD-COMPATIBILITY ALIASES
# =================================================
# These aliases prevent future import failures
# =================================================

def fetch_malware_feed() -> List[Dict]:
    """
    Backward-compatible alias.
    """
    return fetch_malware_activity()


def get_malware_activity() -> List[Dict]:
    """
    Backward-compatible alias.
    """
    return fetch_malware_activity()
